# üìä Story 3.1 ‚Äî Dashboard Implementation Phase 1

**Epic**: 3 - Dashboard & Analytics
**Status**: Draft ‚Üí Ready for Dev
**Priority**: High
**Sprint**: Week 3
**Developer**: @dev
**PM**: Morgan

---

## üéØ Objective

Implement the executive dashboard homepage with key financial metrics, tax analysis overview, and recent advisory updates. This is Phase 1 focusing on core dashboard layout, data visualization, and metric cards built on the existing tax analysis and advisory infrastructure.

---

## üìã Acceptance Criteria

- [ ] Dashboard homepage loads with all KPI cards displaying current company data
- [ ] Tax regime comparison summary shows side-by-side regime metrics
- [ ] Recent filing deadlines displayed with countdown indicators
- [ ] Advisory requests summary shows pending and completed advisories
- [ ] Recharts visualizations render with real data from API
- [ ] Responsive layout works flawlessly on mobile/tablet/desktop
- [ ] Page performance: Loads in < 2 seconds (LCP < 2.5s)
- [ ] All integration tests passing with > 85% code coverage
- [ ] Zero TypeScript errors in strict mode

---

## üöÄ Tasks

### Task 1: Dashboard Layout & Components [Story 3.1.1]
- [ ] Create DashboardLayout wrapper component with sidebar integration
- [ ] Implement KpiCard component (title, value, trend indicator, currency formatting)
- [ ] Create MetricChart component (wrapper for Recharts integration)
- [ ] Build StatusBadge component (for advisory/filing status display)
- [ ] Implement responsive grid system using Tailwind (4-column desktop ‚Üí 1-column mobile)
- [ ] Write component unit tests (>80% coverage)
- [ ] Subtasks:
  - [ ] DashboardLayout.tsx with proper TypeScript types
  - [ ] KpiCard.tsx with trend arrows and color coding
  - [ ] MetricChart.tsx with Recharts ResponsiveContainer
  - [ ] StatusBadge.tsx with role-specific visibility
  - [ ] Dashboard.module.css or Tailwind utilities
  - [ ] Component.test.tsx files with Jest/React Testing Library

### Task 2: API - Dashboard Metrics Endpoint [Story 3.1.2]
- [ ] Create GET /api/v1/dashboard/metrics endpoint in routes/dashboard.ts
- [ ] Implement DashboardService with calculateCompanyMetrics() method
- [ ] Calculate tax regime summary (current + 2 alternatives from TaxAnalysis)
- [ ] Aggregate filing deadlines from Filing model (next 90 days)
- [ ] Count pending advisory requests per company
- [ ] Add caching layer (Redis, 5-minute TTL)
- [ ] Input validation with Zod schema
- [ ] RBAC: Restrict to EMPRESARIO+ roles
- [ ] Error handling with proper HTTP status codes
- [ ] Write API integration tests (>80% coverage)
- [ ] Document endpoint with request/response examples
- [ ] Subtasks:
  - [ ] DashboardService.ts with metric calculations
  - [ ] routes/dashboard.ts with GET /metrics endpoint
  - [ ] lib/validation/dashboard.ts with MetricsRequestSchema
  - [ ] __tests__/dashboard.test.ts with full coverage
  - [ ] Update IMPLEMENTATION_SUMMARY.md with endpoint docs

### Task 3: Frontend - Dashboard Page [Story 3.1.3]
- [ ] Create /dashboard/page.tsx (main dashboard entry)
- [ ] Create useDashboard.ts hook with React Query integration
- [ ] Fetch metrics from GET /api/v1/dashboard/metrics
- [ ] Implement automatic cache invalidation on company change
- [ ] Add loading skeleton component
- [ ] Add error boundary with retry mechanism
- [ ] Implement error toast notifications
- [ ] Test with multiple companies and user roles
- [ ] Write page-level tests
- [ ] Subtasks:
  - [ ] app/dashboard/page.tsx main page
  - [ ] hooks/useDashboard.ts with useQuery setup
  - [ ] DashboardSkeleton.tsx loading state
  - [ ] Error handling and retry logic
  - [ ] __tests__/dashboard-page.test.tsx integration tests

### Task 4: Charts & Visualizations [Story 3.1.4]
- [ ] Implement TaxComparisonChart (bar chart: Simples vs Lucro Presumido vs Lucro Real)
- [ ] Create RevenueProjectionChart (line chart: 12-month trend)
- [ ] Build TaxOpportunitiesChart (horizontal bar: top deductions/credits)
- [ ] Add interactive tooltips and legends
- [ ] Implement responsive behavior (chart resizes on window resize)
- [ ] Add export-to-PDF functionality for charts
- [ ] Performance optimize with React.memo for chart components
- [ ] Write visualization tests (snapshot + interaction tests)
- [ ] Subtasks:
  - [ ] components/dashboard/TaxComparisonChart.tsx
  - [ ] components/dashboard/RevenueProjectionChart.tsx
  - [ ] components/dashboard/TaxOpportunitiesChart.tsx
  - [ ] Chart styling and custom colors (Tailwind theme)
  - [ ] __tests__/charts.test.tsx with Recharts mocking

### Task 5: Testing & Documentation [Story 3.1.5]
- [ ] Write comprehensive unit tests for all components
- [ ] Write integration tests for API + Frontend flow
- [ ] Test responsive behavior on 3 breakpoints (mobile, tablet, desktop)
- [ ] Run lighthouse performance audit (target score > 85)
- [ ] Create user documentation for dashboard features
- [ ] Update IMPLEMENTATION_SUMMARY.md with new endpoints
- [ ] Update README with dashboard access instructions
- [ ] Verify test coverage > 85% across dashboard code
- [ ] Run full test suite and confirm no regressions
- [ ] Subtasks:
  - [ ] Unit tests for all 7 components
  - [ ] Integration tests for dashboard page
  - [ ] E2E tests for user workflows
  - [ ] Lighthouse performance testing
  - [ ] Documentation in docs/ folder
  - [ ] Coverage report generation

---

## üìù Dev Notes

**Data Sources:**
- TaxAnalysis model for regime comparison metrics
- Filing model for deadline tracking
- AdvisoryRequest model for advisory summary
- Company model for basic company info

**Technology Stack:**
- Frontend: Next.js 16+, React 19+, TypeScript
- Charting: Recharts (already in dependencies)
- State Management: React Query (TanStack Query)
- Styling: Tailwind CSS
- Testing: Jest + React Testing Library
- Backend: Express.js, Prisma ORM

**Architecture Decisions:**
- Dashboard metrics cached on API (5-minute TTL) to reduce database load
- React Query manages client-side caching and invalidation
- Charts use ResponsiveContainer for automatic resizing
- Mobile-first responsive design using Tailwind breakpoints

**Performance Considerations:**
- Use React.memo() for chart components to prevent unnecessary re-renders
- Implement request deduplication in React Query
- Lazy load chart libraries if possible
- Optimize Recharts with simplified data structures

**Security & RBAC:**
- Dashboard accessible only to authenticated users
- Restrict metrics endpoint to EMPRESARIO+ roles
- Company data filtered by user's assigned companies

---

## üß™ Testing Strategy

### Unit Tests
- Component rendering with various data states
- KPI card formatting (currency, decimals)
- Status badge color and text based on status
- Chart data transformation logic

### Integration Tests
- API endpoint returns correct metrics structure
- React Query fetches and caches data correctly
- Page renders with fetched data
- Error states display proper messages
- Loading states show and hide correctly

### E2E Tests (if using Playwright/Cypress)
- User navigates to dashboard
- Dashboard loads with company data
- Charts render and are interactive
- User switches between companies and metrics update
- Responsive design works on mobile

### Performance Tests
- First Contentful Paint (FCP) < 1.5s
- Largest Contentful Paint (LCP) < 2.5s
- Cumulative Layout Shift (CLS) < 0.1
- Time to Interactive (TTI) < 3.5s

**Target Coverage**: > 85% for all dashboard-related code

---

## üìã File List (To Create/Modify)

### Frontend Components (NEW)
- `apps/web/src/app/dashboard/page.tsx`
- `apps/web/src/components/dashboard/DashboardLayout.tsx`
- `apps/web/src/components/dashboard/KpiCard.tsx`
- `apps/web/src/components/dashboard/MetricChart.tsx`
- `apps/web/src/components/dashboard/StatusBadge.tsx`
- `apps/web/src/components/dashboard/TaxComparisonChart.tsx`
- `apps/web/src/components/dashboard/RevenueProjectionChart.tsx`
- `apps/web/src/components/dashboard/TaxOpportunitiesChart.tsx`
- `apps/web/src/components/dashboard/DashboardSkeleton.tsx`

### Frontend Hooks & Utils (NEW)
- `apps/web/src/hooks/useDashboard.ts`
- `apps/web/src/lib/validation/dashboard.ts`

### Backend Routes & Services (NEW)
- `apps/api/src/routes/dashboard.ts`
- `apps/api/src/services/DashboardService.ts`

### Tests (NEW)
- `apps/web/__tests__/dashboard/dashboard-page.test.tsx`
- `apps/web/__tests__/dashboard/dashboard-layout.test.tsx`
- `apps/web/__tests__/dashboard/kpi-card.test.tsx`
- `apps/web/__tests__/dashboard/charts.test.tsx`
- `apps/api/__tests__/dashboard.test.ts`

### Documentation (MODIFIED)
- `IMPLEMENTATION_SUMMARY.md` (add Dashboard API docs)
- `README.md` (add Dashboard section)
- `docs/ARCHITECTURE.md` (update with dashboard architecture)

---

## ‚úÖ Definition of Done Checklist

- [ ] All 5 main tasks completed with [x] marks
- [ ] All subtasks completed
- [ ] Code follows TypeScript strict mode (0 errors)
- [ ] Linting passes: `npm run lint` (0 errors)
- [ ] Type checking passes: `npm run typecheck` (0 errors)
- [ ] All tests pass: `npm test` (>85% coverage for dashboard)
- [ ] No console.error or console.warn in production code
- [ ] Code reviewed for security (no SQL injection, XSS, etc.)
- [ ] Documentation updated (API docs, README, inline comments)
- [ ] File List section complete and accurate
- [ ] Ready for @qa code review
- [ ] Ready for production deployment

---

## üìä Dev Agent Record

**Agent**: @dev
**Status**: Ready for Development
**Mode**: Interactive (default) or Yolo (autonomous)
**Model**: Claude Haiku 4.5 / Claude Sonnet 4.5

### Agent Model Used
- [ ] Haiku 4.5
- [ ] Sonnet 4.5

### Completion Notes
- [ ] Phase 1 complete with all tests passing
- [ ] Ready for QA review

### Debug Log
- Story created: 2026-02-10
- Ready for development

### Change Log
- **2026-02-10**: Story created and marked Ready for Dev

---

## üéØ Next Steps

1. **Activate @dev** with `*develop 3.1` to start implementation
2. **Development Mode**: Choose interactive or yolo mode
3. **After completion**: Run full test suite and mark for QA review
4. **Phase 2 (Future)**: Advanced analytics, forecasting, custom reports

---

**Created**: February 10, 2026
**Next Phase**: Story 3.2 - Dashboard Phase 2 (advanced analytics, forecasting)
**Related Stories**: 2.3 (Tax Analysis), 2.4 (Advisory Services)
**Epic**: 3 - Dashboard & Analytics
